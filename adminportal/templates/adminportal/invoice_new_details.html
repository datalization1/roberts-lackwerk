{% extends "adminportal/base.html" %}

{% block portal_content %}
<section class="fig-admin__panel fig-admin__panel--wide fig-invoice-flow">
  <header class="fig-admin__panel-header fig-admin__panel-header--split">
    <div class="fig-admin__panel-header-group">
      <h3>Neue Rechnung</h3>
      <p class="fig-admin__panel-subtitle">Schritt 2 · Rechnungsdetails</p>
    </div>
    <a class="fig-btn fig-btn--ghost fig-btn--compact" href="{% url 'portal_invoice_new_customer' %}">
      <i data-lucide="arrow-left"></i>
      Kunde wechseln
    </a>
  </header>

  <form method="post" action="{% url 'portal_invoice_preview_draft' customer.pk %}" class="fig-invoice-flow__form" data-invoice-form>
    {% csrf_token %}

    <div class="fig-invoice-flow__section">
      <h4>Kunde</h4>
      <div class="fig-customer-card">
        <div class="fig-customer-card__avatar">
          <i data-lucide="user"></i>
        </div>
        <div class="fig-customer-card__content">
          <div class="fig-customer-card__title">
            <span class="fig-customer-card__name">
              {% if customer.company %}
                {{ customer.company }}
              {% else %}
                {{ customer.first_name }} {{ customer.last_name }}
              {% endif %}
            </span>
            {% if customer.source == "damage-report" %}
              <span class="fig-customer-badge fig-customer-badge--info">Schadenmeldung</span>
            {% elif customer.source == "rental" %}
              <span class="fig-customer-badge fig-customer-badge--purple">Vermietung</span>
            {% elif customer.source == "both" %}
              <span class="fig-customer-badge fig-customer-badge--danger">Beide</span>
            {% else %}
              <span class="fig-customer-badge fig-customer-badge--muted">Manuell</span>
            {% endif %}
          </div>
          <div class="fig-customer-card__meta">
            <span><i data-lucide="mail"></i>{{ customer.email|default:"-" }}</span>
            <span><i data-lucide="phone"></i>{{ customer.phone|default:"-" }}</span>
            <span><i data-lucide="map-pin"></i>{{ customer.city|default:"-" }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="fig-invoice-flow__section">
      <h4>Rechnungsdetails</h4>
      <div class="fig-invoice-flow__grid">
        <div class="fig-invoice-flow__field">
          <label>Rechnungsnummer</label>
          <input type="text" name="invoice_number" value="{{ invoice_number }}" readonly>
        </div>
        <div class="fig-invoice-flow__field">
          <label>Rechnungsdatum</label>
          <input type="date" name="issue_date" value="{{ issue_date }}" data-issue-date>
        </div>
        <div class="fig-invoice-flow__field">
          <label>Zahlungsziel</label>
          <select name="payment_term" data-payment-term>
            <option value="14">14 Tage</option>
            <option value="30" selected>30 Tage</option>
            <option value="60">60 Tage</option>
          </select>
          <input type="hidden" name="due_date" value="{{ due_date }}" data-due-date>
          <p class="fig-invoice-flow__hint">Fällig am <span data-due-display>{{ due_date }}</span></p>
        </div>
      </div>
    </div>

    <div class="fig-invoice-flow__section">
      <div class="fig-invoice-flow__section-header">
        <h4>Positionen</h4>
      </div>
      <div class="fig-invoice-flow__items" data-items></div>
      <input type="hidden" name="items_json" value="[]" data-items-json>
    </div>

    <div class="fig-invoice-flow__section">
      <h4>Zusammenfassung</h4>
      <div class="fig-invoice-flow__grid">
        <div class="fig-invoice-flow__field">
          <label>MwSt-Satz (%)</label>
          <select name="vat_rate" data-vat-rate>
            <option value="0" {% if vat_rate == "0" %}selected{% endif %}>0% (befreit)</option>
            <option value="2.5" {% if vat_rate == "2.5" %}selected{% endif %}>2.5% (reduziert)</option>
            <option value="7.7" {% if vat_rate == "7.7" %}selected{% endif %}>7.7% (normal)</option>
          </select>
        </div>
        <div class="fig-invoice-flow__field">
          <label>Preisangaben</label>
          <label class="fig-invoice-flow__checkbox">
            <input type="checkbox" name="vat_included" value="1" {% if vat_included %}checked{% endif %} data-vat-included>
            Preis inkl. MwSt
          </label>
        </div>
        <div class="fig-invoice-flow__field fig-invoice-flow__field--full">
          <label>Anmerkungen</label>
          <textarea name="notes" rows="3">{{ default_notes }}</textarea>
        </div>
      </div>
      <div class="fig-invoice-flow__summary">
        <div>
          <span>Zwischensumme (netto):</span>
          <strong data-subtotal>CHF 0.00</strong>
        </div>
        <div>
          <span>MwSt (<span data-vat-rate-label>7.7</span>%):</span>
          <strong data-vat>CHF 0.00</strong>
        </div>
        <div class="fig-invoice-flow__summary-total">
          <span>Gesamtbetrag (inkl. MwSt):</span>
          <strong data-total>CHF 0.00</strong>
        </div>
        <p class="fig-invoice-flow__hint" data-vat-hint>Preise inkl. MwSt</p>
      </div>
    </div>

    <div class="fig-invoice-flow__actions">
      <a class="fig-btn fig-btn--ghost fig-btn--compact" href="{% url 'portal_invoices' %}">Abbrechen</a>
      <button type="submit" class="fig-btn fig-btn--primary fig-btn--compact">
        <i data-lucide="eye"></i>
        Vorschau anzeigen
      </button>
    </div>
  </form>
</section>

<template id="invoice-item-template">
  <div class="fig-invoice-flow__item" data-item>
    <div class="fig-invoice-flow__item-header">
      <span class="fig-invoice-flow__item-label">Position</span>
      <div class="fig-invoice-flow__item-actions">
        <button type="button" class="fig-btn fig-btn--ghost fig-btn--icon fig-btn--compact fig-btn--danger" data-remove-item>
          <i data-lucide="trash-2"></i>
        </button>
        <button type="button" class="fig-btn fig-btn--ghost fig-btn--icon fig-btn--compact" data-add-item>
          <i data-lucide="plus"></i>
        </button>
      </div>
    </div>
    <div class="fig-invoice-flow__grid fig-invoice-flow__grid--items">
      <div class="fig-invoice-flow__field">
        <label>Beschreibung</label>
        <input type="text" placeholder="Leistungsbeschreibung" data-description>
      </div>
      <div class="fig-invoice-flow__field">
        <label>Menge / Stunden</label>
        <input type="number" min="0" step="0.01" value="1" data-quantity>
      </div>
      <div class="fig-invoice-flow__field">
        <label>Preis (CHF)</label>
        <input type="number" min="0" step="0.01" value="0" data-unit-price>
      </div>
    </div>
    <div class="fig-invoice-flow__item-total">
      Gesamt: <strong data-line-total>CHF 0.00</strong>
    </div>
  </div>
</template>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const itemsContainer = document.querySelector('[data-items]');
    const itemsInput = document.querySelector('[data-items-json]');
    const addItemButton = document.querySelector('[data-add-item]');
    const subtotalEl = document.querySelector('[data-subtotal]');
    const vatEl = document.querySelector('[data-vat]');
    const totalEl = document.querySelector('[data-total]');
    const vatRateSelect = document.querySelector('[data-vat-rate]');
    const vatIncluded = document.querySelector('[data-vat-included]');
    const vatRateLabel = document.querySelector('[data-vat-rate-label]');
    const vatHint = document.querySelector('[data-vat-hint]');
    const issueDateInput = document.querySelector('[data-issue-date]');
    const paymentTermSelect = document.querySelector('[data-payment-term]');
    const dueDateInput = document.querySelector('[data-due-date]');
    const dueDisplay = document.querySelector('[data-due-display]');
    const template = document.getElementById('invoice-item-template');

    const formatMoney = (value) => `CHF ${Number(value).toFixed(2)}`;

    const updateDueDate = () => {
      const base = issueDateInput.value ? new Date(issueDateInput.value) : new Date();
      const days = parseInt(paymentTermSelect.value || '30', 10);
      const due = new Date(base.getTime() + days * 24 * 60 * 60 * 1000);
      const dueIso = due.toISOString().split('T')[0];
      dueDateInput.value = dueIso;
      dueDisplay.textContent = dueIso;
    };

    const recalc = () => {
      const items = [];
      let subtotal = 0;
      document.querySelectorAll('[data-item]').forEach((row) => {
        const description = row.querySelector('[data-description]').value.trim();
        const quantity = parseFloat(row.querySelector('[data-quantity]').value || '0');
        const unitPrice = parseFloat(row.querySelector('[data-unit-price]').value || '0');
        const lineTotal = quantity * unitPrice;
        row.querySelector('[data-line-total]').textContent = formatMoney(lineTotal);
        items.push({
          description,
          quantity,
          unit_price: unitPrice,
        });
        subtotal += lineTotal;
      });
      const vatRate = parseFloat(vatRateSelect.value || '0');
      const isIncluded = vatIncluded && vatIncluded.checked;
      let vatAmount = 0;
      let total = subtotal;
      let netSubtotal = subtotal;
      if (isIncluded) {
        const divisor = 1 + (vatRate / 100);
        netSubtotal = divisor ? (subtotal / divisor) : subtotal;
        vatAmount = subtotal - netSubtotal;
        total = subtotal;
      } else {
        vatAmount = subtotal * (vatRate / 100);
        total = subtotal + vatAmount;
      }
      subtotalEl.textContent = formatMoney(netSubtotal);
      vatEl.textContent = formatMoney(vatAmount);
      totalEl.textContent = formatMoney(total);
      if (vatRateLabel) vatRateLabel.textContent = vatRate.toFixed(1);
      if (vatHint) vatHint.textContent = isIncluded ? 'Preise inkl. MwSt' : 'Preise exkl. MwSt';
      itemsInput.value = JSON.stringify(items);
    };

    const addItem = () => {
      const clone = template.content.cloneNode(true);
      itemsContainer.appendChild(clone);
      const row = itemsContainer.lastElementChild;
      row.querySelectorAll('input').forEach((input) => {
        input.addEventListener('input', recalc);
      });
      row.querySelector('[data-remove-item]').addEventListener('click', () => {
        row.remove();
        recalc();
      });
      row.querySelector('[data-add-item]').addEventListener('click', addItem);
      recalc();
    };

    if (addItemButton) addItemButton.addEventListener('click', addItem);
    vatRateSelect.addEventListener('change', recalc);
    vatIncluded.addEventListener('change', recalc);
    issueDateInput.addEventListener('change', updateDueDate);
    paymentTermSelect.addEventListener('change', updateDueDate);

    updateDueDate();
    const draftItems = {{ draft_items|default:"[]"|safe }};
    if (draftItems.length) {
      itemsContainer.innerHTML = '';
      draftItems.forEach((item) => {
        addItem();
        const row = itemsContainer.lastElementChild;
        row.querySelector('[data-description]').value = item.description || '';
        row.querySelector('[data-quantity]').value = item.quantity || 0;
        row.querySelector('[data-unit-price]').value = item.unit_price || 0;
      });
      recalc();
    } else {
      addItem();
    }
  });
</script>
{% endblock %}
