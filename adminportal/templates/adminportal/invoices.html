{% extends "adminportal/base.html" %}

{% block portal_content %}
<section class="fig-admin__panel fig-admin__panel--wide">
  <header class="fig-admin__panel-header fig-admin__panel-header--split">
    <div class="fig-admin__panel-header-group">
      <h3>Rechnungsverwaltung</h3>
      <p class="fig-admin__panel-subtitle">Alle Rechnungen im Überblick</p>
    </div>
    <div class="fig-invoice-header-actions">
      <form method="get" class="fig-invoice-search">
        <i data-lucide="search"></i>
        <input type="text" name="q" placeholder="Rechnungen suchen..." value="{{ filter.q }}">
      </form>
      <a class="fig-btn fig-btn--primary fig-btn--compact" href="{% url 'portal_invoice_new_customer' %}">
        <i data-lucide="plus"></i>
        Neue Rechnung
      </a>
    </div>
  </header>

  {% if invoice_created %}
    <p class="fig-badge fig-badge--success">Rechnung erfasst.</p>
  {% endif %}

  <div class="fig-invoice-stats">
    <div class="fig-invoice-stat">
      <div class="fig-invoice-stat__value fig-invoice-stat__value--danger">CHF {{ invoice_stats.total_amount|default:"0"|floatformat:0 }}</div>
      <div class="fig-invoice-stat__label">Gesamtumsatz</div>
    </div>
    <div class="fig-invoice-stat">
      <div class="fig-invoice-stat__value fig-invoice-stat__value--success">CHF {{ invoice_stats.paid_total|default:"0"|floatformat:0 }}</div>
      <div class="fig-invoice-stat__label">Bezahlt</div>
    </div>
    <div class="fig-invoice-stat">
      <div class="fig-invoice-stat__value fig-invoice-stat__value--info">CHF {{ invoice_stats.open_total|default:"0"|floatformat:0 }}</div>
      <div class="fig-invoice-stat__label">Ausstehend</div>
    </div>
    <div class="fig-invoice-stat">
      <div class="fig-invoice-stat__value fig-invoice-stat__value--danger">CHF {{ invoice_stats.overdue_total|default:"0"|floatformat:0 }}</div>
      <div class="fig-invoice-stat__label">Überfällig</div>
    </div>
  </div>

  <form method="get" class="fig-invoice-filters">
    <select name="status">
      <option value="">Alle Status</option>
      <option value="draft" {% if filter.status == "draft" %}selected{% endif %}>Entwurf</option>
      <option value="pending" {% if filter.status == "pending" %}selected{% endif %}>Offen</option>
      <option value="paid" {% if filter.status == "paid" %}selected{% endif %}>Bezahlt</option>
      <option value="overdue" {% if filter.status == "overdue" %}selected{% endif %}>Überfällig</option>
      <option value="cancelled" {% if filter.status == "cancelled" %}selected{% endif %}>Storniert</option>
    </select>
    <select name="type">
      <option value="">Alle Typen</option>
      <option value="damage-report" {% if filter.type == "damage-report" %}selected{% endif %}>Schadenmeldung</option>
      <option value="rental" {% if filter.type == "rental" %}selected{% endif %}>Vermietung</option>
      <option value="other" {% if filter.type == "other" %}selected{% endif %}>Sonstiges</option>
    </select>
    <input type="hidden" name="q" value="{{ filter.q }}">
    <button class="fig-btn fig-btn--ghost fig-btn--compact" type="submit">Filtern</button>
  </form>

  <div class="fig-invoice-list">
    {% for invoice in invoices %}
      <article class="fig-invoice-card">
        <div class="fig-invoice-card__icon">
          <i data-lucide="file-text"></i>
        </div>
        <div class="fig-invoice-card__content">
          <div class="fig-invoice-card__header">
            <span class="fig-invoice-card__number">{{ invoice.invoice_number }}</span>
            {% if invoice.status == "paid" %}
              <span class="fig-invoice-badge fig-invoice-badge--success">Bezahlt</span>
            {% elif invoice.status == "overdue" or invoice.is_overdue %}
              <span class="fig-invoice-badge fig-invoice-badge--danger">Überfällig</span>
            {% elif invoice.status == "pending" %}
              <span class="fig-invoice-badge fig-invoice-badge--info">Versendet</span>
            {% elif invoice.status == "draft" %}
              <span class="fig-invoice-badge fig-invoice-badge--muted">Entwurf</span>
            {% else %}
              <span class="fig-invoice-badge fig-invoice-badge--muted">{{ invoice.get_status_display }}</span>
            {% endif %}

            {% if invoice.related_report %}
              <span class="fig-invoice-badge fig-invoice-badge--info">Reparatur</span>
            {% elif invoice.related_booking %}
              <span class="fig-invoice-badge fig-invoice-badge--purple">Vermietung</span>
            {% else %}
              <span class="fig-invoice-badge fig-invoice-badge--muted">Manuell</span>
            {% endif %}
          </div>
          <div class="fig-invoice-card__meta">
            <span><i data-lucide="user"></i>{{ invoice.customer }}</span>
            <span><i data-lucide="calendar"></i>{{ invoice.issue_date|date:"Y-m-d" }}</span>
            <span class="fig-invoice-card__amount"><i data-lucide="banknote"></i>CHF {{ invoice.amount_chf|floatformat:0 }}</span>
          </div>
          <div class="fig-invoice-card__ref">
            {% if invoice.related_report %}
              Bezug: SM-{{ invoice.related_report.pk }}
            {% elif invoice.related_booking %}
              Bezug: BU-{{ invoice.related_booking.pk }}
            {% elif invoice.description %}
              Bezug: {{ invoice.description }}
            {% else %}
              Bezug: -
            {% endif %}
          </div>
        </div>
        <div class="fig-invoice-card__actions">
          <a class="fig-btn fig-btn--ghost fig-btn--icon fig-btn--compact" href="{% url 'portal_invoice_preview' invoice.pk %}">
            <i data-lucide="eye"></i>
            Ansehen
          </a>
          <a class="fig-btn fig-btn--ghost fig-btn--icon fig-btn--compact" href="{% url 'portal_invoice_pdf' invoice.pk %}">
            <i data-lucide="download"></i>
            PDF
          </a>
          <button class="fig-btn fig-btn--ghost fig-btn--icon fig-btn--compact" type="button">
            <i data-lucide="send"></i>
            Senden
          </button>
          {% if invoice.status == "pending" or invoice.status == "overdue" %}
            <form method="post" action="{% url 'portal_invoice_cancel' invoice.pk %}">
              {% csrf_token %}
              <button class="fig-btn fig-btn--ghost fig-btn--icon fig-btn--compact fig-btn--danger" type="submit">
                <i data-lucide="trash-2"></i>
                Stornieren
              </button>
            </form>
          {% endif %}
        </div>
      </article>
    {% empty %}
      <p class="fig-empty">Noch keine Rechnungen erfasst.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}
