{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
.fig-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; padding: 1.5rem; z-index: 40; }
.fig-modal__card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; max-width: 720px; width: 100%; padding: 24px; color: #e2e8f0; }
.fig-modal__card h4 { margin-bottom: 12px; }
.fig-modal__grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 10px 18px; }
.fig-modal__row { display: flex; justify-content: space-between; gap: 12px; }
.fig-modal__label { color: #94a3b8; font-size: 13px; }
.fig-modal__value { color: #e2e8f0; font-weight: 600; }
.fig-modal:target { display: flex; }
.fig-modal__close { float: right; color: #94a3b8; text-decoration: none; }
.fig-filter { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
.fig-filter input, .fig-filter select { background: #0f172a; border: 1px solid #1e293b; color: #e2e8f0; padding: 6px 10px; border-radius: 8px; }
.fig-timeline { display: grid; gap: 10px; margin-top: 14px; }
.fig-timeline__item { border: 1px solid #1e293b; border-radius: 10px; padding: 12px; background: #0b1222; }
.fig-timeline__title { font-weight: 700; }
</style>
<div class="figma-home figma-home--admin">
  <section class="fig-admin">
    <header class="fig-admin__hero">
      <div>
        <p class="fig-eyebrow">Interner Bereich</p>
        <h1>Admin Dashboard</h1>
        <p class="fig-subtitle">Schadenmeldungen, Vermietungen und Fuhrpark im Überblick</p>
      </div>
      <div class="fig-admin__hero-actions">
        <span class="fig-admin__badge">Angemeldet als {{ request.user.username }}</span>
        <a class="fig-btn fig-btn--ghost" href="{% url 'admin_logout' %}">Logout</a>
      </div>
    </header>

    <nav class="fig-admin__tabs">
      <a class="fig-admin__tab {% if active_tab == 'dashboard' %}is-active{% endif %}" href="?tab=dashboard">Dashboard</a>
      <a class="fig-admin__tab {% if active_tab == 'reports' %}is-active{% endif %}" href="?tab=reports">Schadenmeldungen</a>
      <a class="fig-admin__tab {% if active_tab == 'bookings' %}is-active{% endif %}" href="?tab=bookings">Buchungen</a>
      <a class="fig-admin__tab {% if active_tab == 'vehicles' %}is-active{% endif %}" href="?tab=vehicles">Fahrzeuge</a>
    </nav>

    <div class="fig-admin__kpis">
      <article class="fig-admin__card">
        <p class="fig-admin__card-label">Schadenmeldungen</p>
        <div class="fig-admin__card-value">{{ total_reports }}</div>
        <p class="fig-admin__card-meta">Neue in den letzten 7 Tagen: {{ recent_reports_count }}</p>
      </article>
      <article class="fig-admin__card">
        <p class="fig-admin__card-label">Buchungen</p>
        <div class="fig-admin__card-value">{{ total_bookings }}</div>
        <p class="fig-admin__card-meta">Heute geplant: {{ bookings_today }}</p>
      </article>
      <article class="fig-admin__card">
        <p class="fig-admin__card-label">Anstehende Buchungen</p>
        <div class="fig-admin__card-value">{{ upcoming_bookings }}</div>
        <p class="fig-admin__card-meta">inkl. bestätigte Slots</p>
      </article>
      <article class="fig-admin__card">
        <p class="fig-admin__card-label">Transporter im Bestand</p>
        <div class="fig-admin__card-value">{{ transporter_count }}</div>
        <p class="fig-admin__card-meta">Aktive Fahrzeuge</p>
      </article>
    </div>

    {% if active_tab == "dashboard" %}
      <div class="fig-admin__panels">
        <section class="fig-admin__panel">
          <header class="fig-admin__panel-header">
            <h3>Neueste Schadenmeldungen</h3>
            <p class="fig-admin__panel-subtitle">Letzte Eingänge</p>
          </header>
          <div class="fig-list">
            {% for report in recent_reports %}
              <article class="fig-list__item">
                <div>
                  <div class="fig-list__title">
                    {% if report.company_name %}{{ report.company_name }}{% else %}{{ report.first_name }} {{ report.last_name }}{% endif %}
                  </div>
                  <div class="fig-list__meta">
                    {{ report.car_brand }} {{ report.car_model }}{% if report.plate %} · {{ report.plate }}{% endif %}
                  </div>
                </div>
                <div class="fig-badge fig-badge--warning">Neu</div>
              </article>
            {% empty %}
              <p class="fig-empty">Noch keine Schadenmeldungen vorhanden.</p>
            {% endfor %}
          </div>
        </section>

        <section class="fig-admin__panel">
          <header class="fig-admin__panel-header">
            <h3>Anstehende Buchungen</h3>
            <p class="fig-admin__panel-subtitle">Nächste Abholtermine</p>
          </header>
          <div class="fig-list">
            {% for booking in upcoming_booking_list %}
              <article class="fig-list__item">
                <div>
                  <div class="fig-list__title">{{ booking.transporter.name }}</div>
                  <div class="fig-list__meta">
                    {{ booking.customer_name }} · {{ booking.date|date:"d.m.Y" }} · {{ booking.get_time_slot_display }}
                  </div>
                </div>
                <div class="fig-badge fig-badge--success">Bestätigt</div>
              </article>
            {% empty %}
              <p class="fig-empty">Keine zukünftigen Buchungen vorhanden.</p>
            {% endfor %}
          </div>
        </section>
      </div>

      <section class="fig-admin__panel fig-admin__panel--wide">
        <header class="fig-admin__panel-header">
          <h3>Transporter-Übersicht</h3>
          <p class="fig-admin__panel-subtitle">Verfügbare Fahrzeuge im Fuhrpark</p>
        </header>
        <div class="fig-admin__cards">
          {% for transporter in transporters %}
            <article class="fig-admin__card fig-admin__card--inline">
              <div>
                <p class="fig-admin__card-label">Name</p>
                <div class="fig-admin__card-value fig-admin__card-value--small">{{ transporter.name }}</div>
                <p class="fig-admin__card-meta">Kennzeichen: {{ transporter.kennzeichen }}</p>
              </div>
              <div class="fig-admin__card-meta">
                Verfügbar ab {{ transporter.verfuegbar_ab|date:"d.m.Y" }}
              </div>
            </article>
          {% empty %}
            <p class="fig-empty">Noch keine Transporter erfasst.</p>
          {% endfor %}
        </div>
      </section>
    {% elif active_tab == "reports" %}
      <section class="fig-admin__panel fig-admin__panel--wide">
        <header class="fig-admin__panel-header">
          <h3>Alle Schadenmeldungen</h3>
          <p class="fig-admin__panel-subtitle">Neueste Einträge zuerst · Filterbar nach Status/Datum</p>
        </header>
        <form method="get" class="fig-filter">
          <input type="hidden" name="tab" value="reports" />
          <label>
            <span class="fig-modal__label">Status</span>
            <select name="report_status">
              <option value="all" {% if report_status == 'all' %}selected{% endif %}>Alle</option>
              <option value="new" {% if report_status == 'new' %}selected{% endif %}>Neu</option>
              <option value="in_progress" {% if report_status == 'in_progress' %}selected{% endif %}>In Bearbeitung</option>
              <option value="done" {% if report_status == 'done' %}selected{% endif %}>Abgeschlossen</option>
            </select>
          </label>
          <label>
            <span class="fig-modal__label">Von</span>
            <input type="date" name="report_from" value="{% if report_from %}{{ report_from|date:'Y-m-d' }}{% endif %}">
          </label>
          <label>
            <span class="fig-modal__label">Bis</span>
            <input type="date" name="report_to" value="{% if report_to %}{{ report_to|date:'Y-m-d' }}{% endif %}">
          </label>
          <button class="fig-btn fig-btn--ghost" type="submit">Filtern</button>
          <a class="fig-btn fig-btn--ghost" href="?tab=reports">Reset</a>
        </form>
        <div class="fig-table">
          <div class="fig-table__row fig-table__row--head">
            <div class="fig-table__cell fig-table__cell--id">ID</div>
            <div class="fig-table__cell">Kunde</div>
            <div class="fig-table__cell">Fahrzeug</div>
            <div class="fig-table__cell">Datum</div>
            <div class="fig-table__cell">Versicherung</div>
            <div class="fig-table__cell">Aktion</div>
          </div>
          {% for report in reports_list %}
            <div class="fig-table__row">
              <div class="fig-table__cell fig-table__cell--id">SM-{{ report.pk }}</div>
              <div class="fig-table__cell">
                {% if report.company_name %}{{ report.company_name }}{% else %}{{ report.first_name }} {{ report.last_name }}{% endif %}
                <div class="fig-table__meta">{{ report.email }}</div>
              </div>
              <div class="fig-table__cell">
                {{ report.car_brand }} {{ report.car_model }}
                <div class="fig-table__meta">{% if report.plate %}{{ report.plate }}{% endif %}</div>
              </div>
              <div class="fig-table__cell">{{ report.created_at|date:"d.m.Y" }}</div>
              <div class="fig-table__cell">
                {% if report.insurer %}{{ report.insurer }}{% else %}-{% endif %}
              </div>
              <div class="fig-table__cell">
                <a class="fig-btn fig-btn--ghost fig-btn--xs" href="#report-{{ report.pk }}">Details</a>
              </div>
            </div>
            <div class="fig-modal" id="report-{{ report.pk }}">
              <div class="fig-modal__card">
                <a class="fig-modal__close" href="#close">×</a>
                <h4>Schadenmeldung SM-{{ report.pk }}</h4>
                <div class="fig-modal__grid">
                  <div>
                    <div class="fig-modal__label">Kunde</div>
                    <div class="fig-modal__value">
                      {% if report.company_name %}{{ report.company_name }}{% else %}{{ report.first_name }} {{ report.last_name }}{% endif %}
                    </div>
                    <div class="fig-modal__label">{{ report.email }} · {{ report.phone }}</div>
                  </div>
                  <div>
                    <div class="fig-modal__label">Fahrzeug</div>
                    <div class="fig-modal__value">{{ report.car_brand }} {{ report.car_model }}</div>
                    <div class="fig-modal__label">VIN: {{ report.vin|default:"-" }} · Kennz.: {{ report.plate|default:"-" }}</div>
                  </div>
                  <div>
                    <div class="fig-modal__label">Versicherung</div>
                    <div class="fig-modal__value">{{ report.insurer|default:"-" }}</div>
                    <div class="fig-modal__label">Policen-Nr.: {{ report.policy_number|default:"-" }}</div>
                  </div>
                  <div>
                    <div class="fig-modal__label">Status</div>
                    <div class="fig-modal__value">{{ report.get_status_display|default:report.status }}</div>
                  </div>
                </div>
                <hr style="border-color:#1e293b; margin:14px 0;">
                <p class="fig-modal__label">Beschreibung</p>
                <p class="fig-modal__value">{{ report.message|default:"Keine Beschreibung" }}</p>
                <p class="fig-modal__label">Erstellt: {{ report.created_at|date:"d.m.Y H:i" }}</p>
              </div>
            </div>
          {% empty %}
            <p class="fig-empty fig-table__empty">Keine Schadenmeldungen vorhanden.</p>
          {% endfor %}
        </div>
      </section>
    {% elif active_tab == "bookings" %}
      <section class="fig-admin__panel fig-admin__panel--wide">
        <header class="fig-admin__panel-header">
          <h3>Buchungsübersicht</h3>
          <p class="fig-admin__panel-subtitle">Letzte Buchungen · Filterbar nach Status/Datum</p>
        </header>
        <form method="get" class="fig-filter">
          <input type="hidden" name="tab" value="bookings" />
          <label>
            <span class="fig-modal__label">Status</span>
            <select name="booking_status">
              <option value="all" {% if booking_status == 'all' %}selected{% endif %}>Alle</option>
              <option value="pending" {% if booking_status == 'pending' %}selected{% endif %}>Ausstehend</option>
              <option value="confirmed" {% if booking_status == 'confirmed' %}selected{% endif %}>Bestätigt</option>
              <option value="active" {% if booking_status == 'active' %}selected{% endif %}>Aktiv</option>
              <option value="completed" {% if booking_status == 'completed' %}selected{% endif %}>Abgeschlossen</option>
              <option value="cancelled" {% if booking_status == 'cancelled' %}selected{% endif %}>Storniert</option>
            </select>
          </label>
          <label>
            <span class="fig-modal__label">Von</span>
            <input type="date" name="booking_from" value="{% if booking_from %}{{ booking_from|date:'Y-m-d' }}{% endif %}">
          </label>
          <label>
            <span class="fig-modal__label">Bis</span>
            <input type="date" name="booking_to" value="{% if booking_to %}{{ booking_to|date:'Y-m-d' }}{% endif %}">
          </label>
          <button class="fig-btn fig-btn--ghost" type="submit">Filtern</button>
          <a class="fig-btn fig-btn--ghost" href="?tab=bookings">Reset</a>
        </form>
        <div class="fig-table">
          <div class="fig-table__row fig-table__row--head">
            <div class="fig-table__cell fig-table__cell--id">ID</div>
            <div class="fig-table__cell">Transporter</div>
            <div class="fig-table__cell">Kunde</div>
            <div class="fig-table__cell">Datum</div>
            <div class="fig-table__cell">Zeitslot</div>
            <div class="fig-table__cell">Aktion</div>
          </div>
          {% for booking in bookings_list %}
            <div class="fig-table__row">
              <div class="fig-table__cell fig-table__cell--id">BU-{{ booking.pk }}</div>
              <div class="fig-table__cell">
                {{ booking.transporter.name }}
                <div class="fig-table__meta">{{ booking.transporter.kennzeichen }}</div>
              </div>
              <div class="fig-table__cell">
                {{ booking.customer_name }}
                <div class="fig-table__meta">{{ booking.customer_email }}</div>
              </div>
              <div class="fig-table__cell">{{ booking.date|date:"d.m.Y" }}</div>
              <div class="fig-table__cell">{{ booking.get_time_slot_display }}</div>
              <div class="fig-table__cell">
                <a class="fig-btn fig-btn--ghost fig-btn--xs" href="#booking-{{ booking.pk }}">Details</a>
              </div>
            </div>
            <div class="fig-modal" id="booking-{{ booking.pk }}">
              <div class="fig-modal__card">
                <a class="fig-modal__close" href="#close">×</a>
                <h4>Buchung BU-{{ booking.pk }}</h4>
                <div class="fig-modal__grid">
                  <div>
                    <div class="fig-modal__label">Transporter</div>
                    <div class="fig-modal__value">{{ booking.transporter.name }}</div>
                    <div class="fig-modal__label">{{ booking.transporter.kennzeichen }}</div>
                  </div>
                  <div>
                    <div class="fig-modal__label">Zeitraum</div>
                    <div class="fig-modal__value">{{ booking.date|date:"d.m.Y" }} · {{ booking.get_time_slot_display }}</div>
                    <div class="fig-modal__label">Pickup: {{ booking.pickup_date|default:booking.date|date:"d.m.Y" }} {{ booking.pickup_time|default:"" }}</div>
                  </div>
                  <div>
                    <div class="fig-modal__label">Kunde</div>
                    <div class="fig-modal__value">{{ booking.customer_name }}</div>
                    <div class="fig-modal__label">{{ booking.customer_email }} · {{ booking.customer_phone }}</div>
                  </div>
                  <div>
                    <div class="fig-modal__label">Status</div>
                    <div class="fig-modal__value">{{ booking.get_status_display|default:booking.status }}</div>
                    <div class="fig-modal__label">Zahlung: {{ booking.payment_status|default:"-" }}</div>
                  </div>
                </div>
                <hr style="border-color:#1e293b; margin:14px 0;">
                <p class="fig-modal__label">Notizen</p>
                <p class="fig-modal__value">{{ booking.admin_notes|default:"Keine Notizen" }}</p>
              </div>
            </div>
          {% empty %}
            <p class="fig-empty fig-table__empty">Keine Buchungen erfasst.</p>
          {% endfor %}
        </div>

        <h4 style="margin-top:18px;">Timeline (nächste Termine)</h4>
        <div class="fig-timeline">
          {% for b in bookings_timeline %}
            <div class="fig-timeline__item">
              <div class="fig-timeline__title">{{ b.date|date:"d.m.Y" }} · {{ b.get_time_slot_display }}</div>
              <div class="fig-modal__label">{{ b.transporter.name }} ({{ b.transporter.kennzeichen }})</div>
              <div class="fig-modal__value">{{ b.customer_name }}</div>
              <div class="fig-modal__label">Status: {{ b.get_status_display|default:b.status }} · Zahlung: {{ b.payment_status|default:"-" }}</div>
            </div>
          {% empty %}
            <p class="fig-empty">Keine kommenden Buchungen.</p>
          {% endfor %}
        </div>
      </section>
    {% elif active_tab == "vehicles" %}
      <section class="fig-admin__panel fig-admin__panel--wide">
        <header class="fig-admin__panel-header">
          <h3>Fuhrpark</h3>
          <p class="fig-admin__panel-subtitle">Alle registrierten Transporter</p>
        </header>
        <div class="fig-admin__cards fig-admin__cards--grid">
          {% for transporter in transporters %}
            <article class="fig-admin__card fig-admin__card--tall">
              <p class="fig-admin__card-label">Transporter</p>
              <div class="fig-admin__card-value fig-admin__card-value--small">{{ transporter.name }}</div>
              <p class="fig-admin__card-meta">Kennzeichen: {{ transporter.kennzeichen }}</p>
              <p class="fig-admin__card-meta">Farbe: {{ transporter.farbe|default:"-" }}</p>
              <p class="fig-admin__card-meta">Verfügbar ab {{ transporter.verfuegbar_ab|date:"d.m.Y" }}</p>
              <p class="fig-admin__card-meta">Preis: CHF {{ transporter.preis_chf }}</p>
            </article>
          {% empty %}
            <p class="fig-empty">Keine Fahrzeuge hinterlegt.</p>
          {% endfor %}
        </div>
      </section>
    {% endif %}
  </section>
</div>
{% endblock %}
