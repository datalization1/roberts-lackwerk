{% extends "base.html" %}
{% load static %}

{% block body_class %}page-gold{% endblock %}

{% block content %}
<section class="rl-wizard-page">

  <!-- Header -->
  <header class="rl-wizard-header">
    <h1 class="rl-wizard-title">Transporter-Vermietung Buchung</h1>
    <p class="rl-wizard-subtitle">Buchen Sie einen Umzugstransporter für Ihre Umzugsbedürfnisse.</p>
  </header>

  <div class="rl-progress-single">
    <div class="rl-progress-single__top">
      <span class="rl-progress-single__label">Mietdetails</span>
      <span class="rl-progress-single__step">Schritt 1 von 5</span>
    </div>
    <div class="rl-progress-track">
      <span class="rl-progress-fill" style="width: 20%;"></span>
    </div>
  </div>

  <section class="rl-wizard-card">
    <header class="rl-wizard-card__header">
      <h2 class="rl-wizard-card__title">Mietdetails</h2>
      <p class="rl-wizard-card__subtitle">Wählen Sie Ihren Transporter und den Mietzeitraum.</p>
    </header>

      <form method="post">
        {% csrf_token %}

        <div class="rl-wizard-fields">
          {% if form_error %}
            <div class="rl-alert rl-alert--error">{{ form_error }}</div>
          {% endif %}
          <div class="rl-date-row">
            <!-- Abholdatum -->
            <div class="rl-wizard-field-group rl-field-group--date">
              <label class="rl-field-label" for="pickup_date">Abholdatum <span class="rl-field-required">*</span></label>

              <div class="rl-input-wrapper">
                <input id="pickup_date"
                  name="pickup_date"
                  type="date"
                  class="rl-input rl-input--date"
                  placeholder="tt.mm.jjjj"
                  value="{{ step1.date|default:'' }}">

                <span class="rl-input-hint"
                      {% if step1.date %}style="display:none"{% endif %}>
                  Wählen Sie zuerst das Datum, um verfügbare Fahrzeuge zu sehen.
                </span>
              </div>
            </div>

            <!-- Rückgabedatum -->
            <div id="return_date_group" class="rl-wizard-field-group{% if step1.timeblock != 'fullday' and step1.time_slot != 'FULLDAY' %} is-hidden{% endif %}">
              <label class="rl-field-label" for="return_date">Rückgabedatum</label>
              <input id="return_date"
                name="return_date"
                type="date"
                class="rl-input rl-input--date"
                value="{{ step1.return_date|default:'' }}">
              <p class="rl-help-text">Nur bei Ganztags-Mieten erforderlich.</p>
            </div>
          </div>

          <!-- Zeitblock -->
          <div class="form-field">
            <label class="form-label">Zeitblock auswählen *</label>
            <div class="rl-timeblock-grid">
              <label class="rl-timeblock-card">
                <input type="radio" name="time_block" value="morning" class="rl-timeblock-input"
                  {% if step1.timeblock == 'morning' or step1.time_slot == 'MORNING' %}checked{% endif %}>
                <div class="rl-timeblock-inner">
                  <div class="rl-timeblock-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false">
                      <circle cx="12" cy="12" r="4"></circle>
                      <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
                    </svg>
                  </div>
                  <div class="rl-timeblock-content">
                    <div class="rl-timeblock-title">Vormittag</div>
                    <div class="rl-timeblock-range">08:00 – 12:00</div>
                  </div>
                </div>
              </label>

              <label class="rl-timeblock-card">
                <input type="radio" name="time_block" value="afternoon" class="rl-timeblock-input"
                  {% if step1.timeblock == 'afternoon' or step1.time_slot == 'AFTERNOON' %}checked{% endif %}>
                <div class="rl-timeblock-inner">
                  <div class="rl-timeblock-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false">
                      <path d="M12 3v5"></path>
                      <path d="m16 7-4 4-4-4"></path>
                      <path d="M4 21h16"></path>
                      <path d="M4 17h16"></path>
                      <path d="M8 21h8"></path>
                    </svg>
                  </div>
                  <div class="rl-timeblock-content">
                    <div class="rl-timeblock-title">Nachmittag</div>
                    <div class="rl-timeblock-range">13:00 – 18:00</div>
                  </div>
                </div>
              </label>

              <label class="rl-timeblock-card">
                <input type="radio" name="time_block" value="fullday" class="rl-timeblock-input"
                  {% if step1.timeblock == 'fullday' or step1.time_slot == 'FULLDAY' %}checked{% endif %}>
                <div class="rl-timeblock-inner">
                  <div class="rl-timeblock-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false">
                      <circle cx="12" cy="12" r="9"></circle>
                      <path d="M12 7v5l3 3"></path>
                    </svg>
                  </div>
                  <div class="rl-timeblock-content">
                    <div class="rl-timeblock-title">Ganztag</div>
                    <div class="rl-timeblock-range">08:00 – 18:00</div>
                  </div>
                </div>
              </label>
            </div>
            <p class="rl-text-muted rl-text-muted--small">
              Hinweis: Bei verspäteter Rückgabe wird ein weiterer Halbtag verrechnet.
            </p>
          </div>

          <!-- Verfügbarkeits-Banner + Modelle -->
          <div class="rl-rental-status {% if all_available %}rl-rental-status--ok{% elif any_unavailable %}rl-rental-status--warn{% endif %}">
            <div class="rl-rental-status__text">
              {% if not has_filter %}
                <strong>Bitte Abholdatum & Zeitblock wählen.</strong>
                <span>Wählen Sie zuerst das Datum, um verfügbare Fahrzeuge zu sehen.</span>
              {% elif all_available %}
                <strong>Alle Fahrzeuge verfügbar!</strong>
                <span>Wählen Sie Ihr bevorzugtes Modell.</span>
              {% else %}
                <strong>{{ available_count }} von {{ total_count }} Fahrzeugen verfügbar</strong>
                <span>für den gewählten Zeitraum.</span>
              {% endif %}
            </div>
          </div>

          <label class="rl-field-label">Modell auswählen <span class="rl-field-required">*</span></label>

          {% if has_filter %}
            {% if available_count > 0 and transporters %}
              <div class="rl-rental-grid">
                {% for t in transporters %}
                  {% if not t.is_unavailable %}
                    <label class="rl-rental-card">
                      <input type="radio" name="transporter_id" value="{{ t.id }}" class="rl-rental-card__input"
                        {% if step1.transporter_id %}
                          {% if step1.transporter_id == t.id %}checked{% endif %}
                        {% elif forloop.first %}
                          checked
                        {% endif %}>
                      <div class="rl-rental-card__inner">
                        <span class="rl-rental-card__badge rl-rental-card__badge--available">Verfügbar</span>
                        {% if t.image %}
                          <div class="rl-rental-card__image" style="background-image:url('{{ t.image.url }}');"></div>
                        {% else %}
                          <div class="rl-rental-card__image rl-rental-card__image--placeholder"></div>
                        {% endif %}
                        <div class="rl-rental-card__body">
                          <h3 class="rl-rental-card__title">{{ t.name }}</h3>
                          {% if t.farbe %}<p class="rl-rental-card__meta">Farbe: {{ t.farbe }}</p>{% endif %}
                          {% if t.preis_chf %}<p class="rl-rental-card__price">CHF {{ t.preis_chf|floatformat:0 }}</p>{% endif %}
                        </div>
                      </div>
                    </label>
                  {% endif %}
                {% endfor %}
              </div>
            {% else %}
              <p class="rl-text-muted">Leider ist kein Fahrzeug für diesen Zeitraum verfügbar.</p>
            {% endif %}
          {% else %}
            <p class="rl-text-muted">Bitte Abholdatum und Zeitblock wählen, um verfügbare Fahrzeuge zu sehen.</p>
          {% endif %}
        </div>

        <footer class="rl-wizard-footer">
          <button type="button" class="rl-btn-secondary" disabled>← Zurück</button>
          <div class="rl-wizard-actions-right">
            <button type="submit" class="rl-btn-primary">Weiter →</button>
          </div>
        </footer>
      </form>
  </section>
</section>
<script>
document.addEventListener('DOMContentLoaded',function(){
  const radios = document.querySelectorAll('input[name="time_block"]');
  const returnGroup = document.getElementById('return_date_group');
  const hint = document.querySelector('.rl-input-hint');
  const input = document.getElementById('pickup_date');
  if (!returnGroup) return;

  function toggleHint() {
    if (!input || !hint) return;
    hint.style.display = input.value ? "none" : "block";
  }

  function updateReturnVisibility(){
    const selected = document.querySelector('input[name="time_block"]:checked');
    if (selected && selected.value === 'fullday'){
      returnGroup.classList.remove('is-hidden');
    }else{
      returnGroup.classList.add('is-hidden');
    }
  }

  radios.forEach(r => r.addEventListener('change', updateReturnVisibility));
  if (input) {
    input.addEventListener('change', toggleHint);
    toggleHint();
  }
  updateReturnVisibility();
});
</script>
<style>
  .rl-rental-card__image--placeholder {
    background: linear-gradient(135deg, #1e293b, #0f172a);
  }
</style>
{% endblock %}
