{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="rl-wizard-page">

  <a href="{% url 'home' %}" class="rl-wizard-back">â† ZurÃ¼ck zur Startseite</a>

  <!-- Header -->
  <header class="rl-wizard-header">
    <h1 class="rl-wizard-title">Buchung Transporter</h1>
    <p class="rl-wizard-subtitle">Buchen Sie einen Transporter fÃ¼r Ihre UmzugsbedÃ¼rfnisse.</p>
  </header>

  <!-- Progress Card -->
  <section class="rl-wizard-card rl-wizard-card--progress">
    <div class="rl-wizard-progress">
      <div class="rl-wizard-progress__top">
        <span>Schritt 1 von 5</span>
        <span>20% Abgeschlossen</span>
      </div>
      <div class="progress-track">
        <div class="progress-bar" style="width:20%;"></div>
      </div>
    </div>
  </section>

  <section class="rl-wizard-card">
    <header class="rl-wizard-card__header">
      <h2 class="rl-wizard-card__title">Mietdetails</h2>
      <p class="rl-wizard-card__subtitle">WÃ¤hlen Sie Ihren LKW und den Mietzeitraum.</p>
    </header>

      <form method="post">
        {% csrf_token %}

        <div class="rl-wizard-fields">

          <!-- Abholdatum -->
          <div class="rl-wizard-field-group rl-field-group--date">
            <label class="rl-field-label" for="pickup_date">Abholdatum <span class="rl-field-required">*</span></label>

            <div class="rl-input-wrapper">
              <input id="pickup_date"
                name="pickup_date"
                type="date"
                class="rl-input rl-input--date"
                value="{{ step1.date|default:'' }}">

              <span class="rl-input-hint"
                    {% if step1.date %}style="display:none"{% endif %}>
                WÃ¤hlen Sie zuerst das Datum, um verfÃ¼gbare Fahrzeuge zu sehen.
              </span>
            </div>
          </div>

          <!-- Zeitblock -->
          <div class="form-field">
            <label class="form-label">Zeitblock auswÃ¤hlen *</label>
            <div class="rl-timeblock-grid">
              <label class="rl-timeblock-card">
                <input type="radio" name="time_block" value="morning" class="rl-timeblock-input">
                <div class="rl-timeblock-inner">
                  <div class="rl-timeblock-icon">ğŸŒ…</div>
                  <div class="rl-timeblock-content">
                    <div class="rl-timeblock-title">Vormittag</div>
                    <div class="rl-timeblock-range">08:00 â€“ 12:00</div>
                  </div>
                </div>
              </label>

              <label class="rl-timeblock-card">
                <input type="radio" name="time_block" value="afternoon" class="rl-timeblock-input">
                <div class="rl-timeblock-inner">
                  <div class="rl-timeblock-icon">ğŸŒ‡</div>
                  <div class="rl-timeblock-content">
                    <div class="rl-timeblock-title">Nachmittag</div>
                    <div class="rl-timeblock-range">13:00 â€“ 18:00</div>
                  </div>
                </div>
              </label>

              <label class="rl-timeblock-card">
                <input type="radio" name="time_block" value="fullday" class="rl-timeblock-input">
                <div class="rl-timeblock-inner">
                  <div class="rl-timeblock-icon">ğŸŒ•</div>
                  <div class="rl-timeblock-content">
                    <div class="rl-timeblock-title">Ganztag</div>
                    <div class="rl-timeblock-range">08:00 â€“ 18:00</div>
                  </div>
                </div>
              </label>
            </div>
          </div>

          <!-- RÃ¼ckgabedatum -->
          <div id="return_date_group" class="rl-wizard-field-group{% if step1.timeblock != 'fullday' %} is-hidden{% endif %}">
            <label class="rl-field-label" for="return_date">RÃ¼ckgabedatum</label>
            <input id="return_date"
              name="return_date"
              type="date"
              class="rl-input rl-input--date"
              value="{{ step1.return_date|default:'' }}">
            <p class="rl-help-text">Nur bei Ganztags-Mieten erforderlich.</p>
          </div>

          <!-- VerfÃ¼gbarkeits-Banner + Modelle -->
          <div class="rl-rental-status {% if all_available %}rl-rental-status--ok{% elif any_unavailable %}rl-rental-status--warn{% endif %}">
            <div class="rl-rental-status__text">
              {% if not has_filter %}
                <strong>Bitte Abholdatum & Zeitblock wÃ¤hlen.</strong>
                <span> Danach zeigen wir die VerfÃ¼gbarkeit der Fahrzeuge an.</span>
              {% else %}
                <strong>{{ available_count }} von {{ total_count }} Fahrzeugen verfÃ¼gbar</strong>
                <span>fÃ¼r den gewÃ¤hlten Zeitraum.</span>
              {% endif %}
            </div>
          </div>

          <label class="rl-field-label">Modell auswÃ¤hlen <span class="rl-field-required">*</span></label>

          {% if transporters %}
            <div class="rl-rental-grid">
              {% for t in transporters %}
                <label class="rl-rental-card {% if t.is_unavailable %}rl-rental-card--unavailable{% endif %}">
                  <input type="radio" name="transporter_id" value="{{ t.id }}" class="rl-rental-card__input"
                        {% if t.is_unavailable %}
                          disabled
                        {% else %}
                          {% if step1.transporter_id %}
                            {% if step1.transporter_id == t.id %}checked{% endif %}
                          {% elif forloop.first %}
                            checked
                          {% endif %}
                        {% endif %}>
                  <div class="rl-rental-card__inner">
                    {% if t.is_unavailable %}
                      <span class="rl-rental-card__badge rl-rental-card__badge--unavailable">Ausgebucht</span>
                    {% else %}
                      <span class="rl-rental-card__badge rl-rental-card__badge--available">VerfÃ¼gbar</span>
                    {% endif %}
                    <div class="rl-rental-card__image" {% if t.image %}style="background-image:url('{{ t.image.url }}');"{% endif %}></div>
                    <div class="rl-rental-card__body">
                      <h3 class="rl-rental-card__title">{{ t.name }}</h3>
                      {% if t.farbe %}<p class="rl-rental-card__meta">Farbe: {{ t.farbe }}</p>{% endif %}
                      {% if t.preis_chf %}<p class="rl-rental-card__price">CHF {{ t.preis_chf|floatformat:0 }}</p>{% endif %}
                      {% if t.is_unavailable and t.next_available_date %}
                        <p class="rl-rental-card__note">NÃ¤chste VerfÃ¼gbarkeit:<br>{{ t.next_available_date|date:"j.n.Y" }}</p>
                      {% endif %}
                    </div>
                  </div>
                </label>
              {% empty %}
                <p class="rl-text-muted">Aktuell sind keine Transporter verfÃ¼gbar.</p>
              {% endfor %}
            </div>
          {% else %}
            <p class="rl-text-muted">Aktuell sind keine Transporter verfÃ¼gbar.</p>
          {% endif %}
        </div>

        <footer class="rl-wizard-footer">
          <button type="button" class="rl-btn-secondary" disabled>â† ZurÃ¼ck</button>
          <div class="rl-wizard-actions-right">
            <button type="submit" class="rl-btn-primary">Weiter â†’</button>
          </div>
        </footer>
        <script>
        document.addEventListener('DOMContentLoaded', () => {
          const input = document.getElementById('pickup_date');
          const hint = document.querySelector('.rl-input-hint');

          function toggleHint() {
            if (!input || !hint) return;
            if (input.value) {
              hint.style.display = "none";
            } else {
              hint.style.display = "block";
            }
          }

          input.addEventListener('change', toggleHint);
          toggleHint();
        });
        </script>
      </form>
      </footer>
    </form>
  </section>
</section>
<script>
document.addEventListener('DOMContentLoaded',function(){
  const radios = document.querySelectorAll('input[name="timeblock"]');
  const returnGroup = document.getElementById('return_date_group');
  if (!returnGroup || !radios.length) return;

  function updateReturnVisibility(){
    const selected = document.querySelector('input[name="timeblock"]:checked');
    if (selected && selected.value === 'fullday'){
      returnGroup.classList.remove('is-hidden');
    }else{
      returnGroup.classList.add('is-hidden');
    }
  }

  radios.forEach(r => r.addEventListener('change', updateReturnVisibility));
  updateReturnVisibility();
});
</script>
{% endblock %}