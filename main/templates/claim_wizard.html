{% extends "base.html" %}
{% load static %}

{% block body_class %}page-gold{% endblock %}

{% block content %}
<section class="rl-wizard-page rl-claim-wizard">

  <!-- Kopfbereich + Fortschritt -->
  {% with current=wizard.steps.step1 total=wizard.steps.count %}
    {% widthratio current total 100 as progress %}
    <header class="rl-wizard-header">
      <h1 class="rl-wizard-title">Schadenmeldung</h1>

      {% if wizard.steps.current == "car" %}
        <p class="rl-wizard-subtitle">Bitte geben Sie die Fahrzeugdaten ein, damit wir den Schaden eindeutig zuordnen können.</p>
      {% elif wizard.steps.current == "personal" %}
        <p class="rl-wizard-subtitle">Tragen Sie Ihre Kontaktdaten ein, damit wir Sie bei Rückfragen erreichen können.</p>
      {% elif wizard.steps.current == "insurance" %}
        <p class="rl-wizard-subtitle">Ergänzen Sie die Angaben zu Ihrer Versicherung und allfälligen Dokumenten.</p>
      {% elif wizard.steps.current == "accident" %}
        <p class="rl-wizard-subtitle">Beschreiben Sie den Schaden und laden Sie bei Bedarf Fotos hoch.</p>
      {% elif wizard.steps.current == "review" %}
        <p class="rl-wizard-subtitle">Bitte prüfen Sie alle Angaben und bestätigen Sie die Schadenmeldung.</p>
      {% endif %}

      <div class="rl-progress-single">
        <div class="rl-progress-single__top">
          <span class="rl-progress-single__label">
            {% if wizard.steps.current == "car" %}Fahrzeugdetails{% elif wizard.steps.current == "personal" %}Persönliche Daten{% elif wizard.steps.current == "insurance" %}Versicherungsdetails{% elif wizard.steps.current == "accident" %}Unfalldetails{% else %}Zusammenfassung{% endif %}
          </span>
          <span class="rl-progress-single__step">Schritt {{ wizard.steps.step1 }} von {{ wizard.steps.count }}</span>
        </div>
        <div class="rl-progress-track">
          <span class="rl-progress-fill" style="width: {{ progress }}%;"></span>
        </div>
      </div>
    </header>
  {% endwith %}

  <!-- Karten-Formular -->
  <section class="rl-wizard-card">
    <header class="rl-wizard-card__header">
      <h2 class="rl-card__title">
        {% if wizard.steps.current == "car" %}
          Fahrzeugdaten
        {% elif wizard.steps.current == "personal" %}
          Personendaten
        {% elif wizard.steps.current == "insurance" %}
          Versicherungsdaten
        {% elif wizard.steps.current == "accident" %}
          Schadendetails &amp; Fotos
        {% elif wizard.steps.current == "review" %}
          Zusammenfassung
        {% endif %}
      </h2>
    </header>
    {% if form.errors %}
    <div style="padding:1rem; background:#500; color:#fff; border-radius:8px; margin-bottom:1rem;">
        <h4>Formularfehler:</h4>
        <pre>{{ form.errors.as_json }}</pre>
    </div>
    {% endif %}
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {{ wizard.management_form }}
      {{ form.non_field_errors }}
      {% if form.errors %}
        <div style="color: #ff6b6b; background: #300; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <strong>Formularfehler:</strong>
            <pre>{{ form.errors }}</pre>
        </div>
      {% endif %}
      <div class="rl-wizard-fields">

{# ---------- STEP 1: Fahrzeug (car) ---------- #}
{% if wizard.steps.current == "car" %}
  <div class="rl-wizard-field-group">
    <label class="rl-wizard-label" for="{{ form.plate.id_for_label }}">Kontrollschild *</label>
    {{ form.plate }} {{ form.plate.errors }}
  </div>
  <div class="rl-wizard-field-group rl-wizard-field-inline">
    <div>
      <label class="rl-wizard-label" for="{{ form.car_brand.id_for_label }}">Fahrzeugmarke *</label>
      {{ form.car_brand }} {{ form.car_brand.errors }}
    </div>
    <div>
      <label class="rl-wizard-label" for="{{ form.car_model.id_for_label }}">Fahrzeugmodell *</label>
      {{ form.car_model }} {{ form.car_model.errors }}
    </div>
  </div>
  <div class="rl-wizard-field-group">
    <label class="rl-wizard-label" for="{{ form.vin.id_for_label }}">Stammnummer (Format 123.456.789)</label>
    {{ form.vin }} {{ form.vin.errors }}
    <p class="rl-wizard-help">Schweizer Stammnummer aus Fahrzeugausweis, Feld 18.</p>
  </div>
  <div class="rl-wizard-field-group">
    <label class="rl-wizard-label" for="{{ form.type_certificate_number.id_for_label }}">Typenscheinnummer (6-stellig)</label>
    {{ form.type_certificate_number }} {{ form.type_certificate_number.errors }}
    <p class="rl-wizard-help">Feld 24 im Fahrzeugausweis (6-stellig).</p>
  </div>
  <div class="rl-wizard-field-group">
    <label class="rl-wizard-label" for="{{ form.registration_document.id_for_label }}">Fahrzeugausweis (optional)</label>
    {{ form.registration_document }} {{ form.registration_document.errors }}
    {% if car_registration_document %}
      <p class="rl-wizard-help">
        Bereits hochgeladen:
        {% if car_registration_document.url %}
          <a href="{{ car_registration_document.url }}" target="_blank">{{ car_registration_document.name|default:"Datei" }}</a>
        {% else %}
          {{ car_registration_document.name|default:"Datei" }}
        {% endif %}
      </p>
    {% endif %}
    <p class="rl-wizard-help">Foto oder PDF des Fahrzeugausweises hochladen (optional).</p>
  </div>
{% endif %}

{# ---------- STEP 2: Person (personal) ---------- #}
{% if wizard.steps.current == "personal" %}
  <div class="rl-wizard-field-group rl-wizard-field-inline">
    <div>
      <label class="rl-wizard-label" for="{{ form.first_name.id_for_label }}">Vorname *</label>
      {{ form.first_name }} {{ form.first_name.errors }}
    </div>
    <div>
      <label class="rl-wizard-label" for="{{ form.last_name.id_for_label }}">Nachname *</label>
      {{ form.last_name }} {{ form.last_name.errors }}
    </div>
  </div>
  <div class="rl-wizard-field-group rl-wizard-field-inline">
    <div>
      <label class="rl-wizard-label" for="{{ form.address_street.id_for_label }}">Strasse & Nr. (optional)</label>
      {{ form.address_street }} {{ form.address_street.errors }}
    </div>
    <div>
      <label class="rl-wizard-label" for="{{ form.postal_code.id_for_label }}">PLZ (optional)</label>
      {{ form.postal_code }} {{ form.postal_code.errors }}
    </div>
  </div>
  <div class="rl-wizard-field-group rl-wizard-field-inline">
    <div>
      <label class="rl-wizard-label" for="{{ form.city.id_for_label }}">Ort (optional)</label>
      {{ form.city }} {{ form.city.errors }}
    </div>
    <div>
      <label class="rl-wizard-label" for="{{ form.phone.id_for_label }}">Telefon *</label>
      {{ form.phone }} {{ form.phone.errors }}
    </div>
  </div>
  <div class="rl-wizard-field-group">
    <label class="rl-wizard-label" for="{{ form.email.id_for_label }}">E-Mail *</label>
    {{ form.email }} {{ form.email.errors }}
  </div>
{% endif %}

{# ---------- STEP 3: Versicherung (insurance) ---------- #}
{% if wizard.steps.current == "insurance" %}
  <div class="rl-wizard-field-group">
    <label class="rl-wizard-label" for="{{ form.insurer.id_for_label }}">Versicherung *</label>
    {{ form.insurer }} {{ form.insurer.errors }}
  </div>
  <div class="rl-wizard-field-group">
    <label class="rl-wizard-label" for="{{ form.other_insurer.id_for_label }}">Andere Versicherung</label>
    {{ form.other_insurer }} {{ form.other_insurer.errors }}
    <p class="rl-wizard-help">Nur ausfüllen, wenn "Andere" ausgewählt ist.</p>
  </div>
  <div class="rl-wizard-field-group rl-wizard-field-inline">
    <div>
      <label class="rl-wizard-label" for="{{ form.policy_number.id_for_label }}">Policennummer</label>
      {{ form.policy_number }} {{ form.policy_number.errors }}
      <p class="rl-wizard-help">Optional, falls vorhanden.</p>
    </div>
    <div>
      <label class="rl-wizard-label" for="{{ form.accident_number.id_for_label }}">Schadennummer</label>
      {{ form.accident_number }} {{ form.accident_number.errors }}
    </div>
  </div>
  <div class="rl-wizard-field-group">
    <label class="rl-wizard-label" for="{{ form.insurer_contact.id_for_label }}">Kontakt bei der Versicherung</label>
    {{ form.insurer_contact }} {{ form.insurer_contact.errors }}
  </div>
  <div class="rl-wizard-field-group rl-wizard-field-inline">
    <div>
      <label class="rl-wizard-label" for="{{ form.insurer_contact_phone.id_for_label }}">Telefon Kontaktperson</label>
      {{ form.insurer_contact_phone }} {{ form.insurer_contact_phone.errors }}
    </div>
    <div>
      <label class="rl-wizard-label" for="{{ form.insurer_contact_email.id_for_label }}">E-Mail Kontaktperson</label>
      {{ form.insurer_contact_email }} {{ form.insurer_contact_email.errors }}
    </div>
  </div>
{% endif %}

        {# ---------- STEP 4: Schaden (accident) ---------- #}
        {% if wizard.steps.current == "accident" %}
          <div class="rl-wizard-field-group">
            <label class="rl-wizard-label" for="{{ form.accident_date.id_for_label }}">Unfalldatum *</label>
            <div style="max-width:260px;">{{ form.accident_date }} {{ form.accident_date.errors }}</div>
          </div>
          <div class="rl-wizard-field-group">
            <label class="rl-wizard-label" for="{{ form.accident_location.id_for_label }}">Unfallort *</label>
            {{ form.accident_location }} {{ form.accident_location.errors }}
          </div>
          <div class="rl-wizard-field-group">
            <label class="rl-wizard-label" for="{{ form.damage_type.id_for_label }}">Schadensart *</label>
            {{ form.damage_type }} {{ form.damage_type.errors }}
          </div>
          <div class="rl-wizard-field-group">
            <label class="rl-wizard-label">Beschädigte Teile</label>
            <ul class="rl-checkbox-grid">
                {% for checkbox in form.damaged_parts %}
                    <li>
                        {{ checkbox.tag }}
                        <label for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                    </li>
                {% endfor %}
            </ul>

            {{ form.damaged_parts.errors }}
          </div>
          <div class="rl-wizard-field-group">
            <label class="rl-wizard-label" for="{{ form.message.id_for_label }}">Schadenbeschreibung *</label>
            {{ form.message }} {{ form.message.errors }}
          </div>
          <div class="rl-wizard-field-group rl-wizard-field-inline">
            <div>
              <label class="rl-wizard-label" for="{{ form.other_party_involved.id_for_label }}">Unfallgegner vorhanden?</label>
              {{ form.other_party_involved }}
            </div>
            <div>
              <label class="rl-wizard-label" for="{{ form.police_involved.id_for_label }}">Polizei involviert?</label>
              {{ form.police_involved }}
            </div>
          </div>
          <div class="rl-wizard-field-group">
            <label class="rl-wizard-label" for="{{ form.photos.id_for_label }}">Schadenfotos *</label>
            <p class="rl-wizard-help">Laden Sie klare Fotos der beschädigten Bereiche hoch (bis zu 5 Bilder, je max. 5 MB).</p>

            <div class="rl-upload-dropzone">
              <div class="rl-upload-icon">⬆</div>
              <div class="rl-upload-text">
                <div class="rl-upload-title">Klicken Sie, um Bilder hochzuladen</div>
                <div class="rl-upload-sub">PNG, JPG bis zu 5MB pro Bild</div>
              </div>
            </div>

            <div class="rl-upload-input">
              {{ form.photos }}
            </div>

            <div class="rl-upload-filelist"></div>

            {{ form.photos.errors }}
          </div>
          <div class="rl-wizard-field-group">
            <label class="rl-wizard-label" for="{{ form.documents.id_for_label }}">Dokumente (optional)</label>
            <p class="rl-wizard-help">Polizeibericht oder Skizze (PDF/JPG/PNG, max. 5 Dateien).</p>
            {{ form.documents }}
            {{ form.documents.errors }}
          </div>
        {% endif %}

        {# ---------- STEP 5: Review (review) ---------- #}
        {% if wizard.steps.current == "review" %}
          <div class="rl-wizard-field-group">
            <p class="rl-wizard-subtitle" style="margin-bottom:1rem;">
              Bitte prüfen Sie Ihre Angaben. Wenn alles korrekt ist, senden Sie die Meldung ab.
            </p>
          </div>

          <div class="rl-summary-grid">
            <!-- Fahrzeugdaten -->
            <section class="rl-summary-section">
              <h3 class="rl-summary-title">Fahrzeugdaten</h3>
              <dl class="rl-summary-list">
                <div><dt>Kontrollschild</dt><dd>{{ summary.car.plate|default:"–" }}</dd></div>
                <div><dt>Marke</dt><dd>{{ summary.car.car_brand|default:"–" }}</dd></div>
                <div><dt>Modell</dt><dd>{{ summary.car.car_model|default:"–" }}</dd></div>
                <div><dt>Stammnummer</dt><dd>{{ summary.car.vin|default:"–" }}</dd></div>
                <div><dt>Typenscheinnummer</dt><dd>{{ summary.car.type_certificate_number|default:"–" }}</dd></div>
                <div>
                  <dt>Fahrzeugausweis</dt>
                  <dd>
                    {% if summary.car.registration_document %}
                      {% if summary.car.registration_document.url %}
                        <a href="{{ summary.car.registration_document.url }}" target="_blank">{{ summary.car.registration_document.name|default:"Datei" }}</a>
                      {% else %}
                        {{ summary.car.registration_document.name|default:"Datei" }}
                      {% endif %}
                    {% else %}
                      –
                    {% endif %}
                  </dd>
                </div>
              </dl>
            </section>

            <!-- Personendaten -->
            <section class="rl-summary-section">
              <h3 class="rl-summary-title">Personendaten</h3>
              <dl class="rl-summary-list">
                <div><dt>Name</dt><dd>{{ summary.personal.first_name }} {{ summary.personal.last_name }}</dd></div>
                <div><dt>Adresse</dt><dd>{{ summary.personal.address_street }} {{ summary.personal.postal_code }} {{ summary.personal.city }}</dd></div>
                <div><dt>Telefon</dt><dd>{{ summary.personal.phone|default:"–" }}</dd></div>
                <div><dt>E-Mail</dt><dd>{{ summary.personal.email|default:"–" }}</dd></div>
              </dl>
            </section>

            <!-- Versicherung -->
            <section class="rl-summary-section">
              <h3 class="rl-summary-title">Versicherung</h3>
              <dl class="rl-summary-list">
                <div><dt>Versicherung</dt><dd>{{ summary.insurance.insurer|default:"–" }}</dd></div>
                <div><dt>Andere Versicherung</dt><dd>{{ summary.insurance.other_insurer|default:"–" }}</dd></div>
                <div><dt>Police-Nr.</dt><dd>{{ summary.insurance.policy_number|default:"–" }}</dd></div>
                <div><dt>Schaden-Nr.</dt><dd>{{ summary.insurance.accident_number|default:"–" }}</dd></div>
                <div><dt>Kontakt</dt><dd>{{ summary.insurance.insurer_contact|default:"–" }}</dd></div>
                <div><dt>Kontakt Telefon</dt><dd>{{ summary.insurance.insurer_contact_phone|default:"–" }}</dd></div>
                <div><dt>Kontakt E-Mail</dt><dd>{{ summary.insurance.insurer_contact_email|default:"–" }}</dd></div>
              </dl>
            </section>

            <!-- Schaden -->
            <section class="rl-summary-section rl-summary-section--full">
              <h3 class="rl-summary-title">Schaden</h3>
              <dl class="rl-summary-list">
                <div>
                  <dt>Beschädigte Teile</dt>
                  <dd>
                    {% if damaged_parts_labels %}
                      {{ damaged_parts_labels|join:", " }}
                    {% elif summary.accident.damaged_parts %}
                      {{ summary.accident.damaged_parts|join:", " }}
                    {% else %}
                      –
                    {% endif %}
                  </dd>
                </div>
                <div>
                  <dt>Beschreibung</dt>
                  <dd>{{ summary.accident.message|default:"–" }}</dd>
                </div>
                <div>
                  <dt>Unfalldatum</dt>
                  <dd>{{ summary.accident.accident_date|default:"–" }}</dd>
                </div>
                <div>
                  <dt>Unfallort</dt>
                  <dd>{{ summary.accident.accident_location|default:"–" }}</dd>
                </div>
                <div>
                  <dt>Schadensart</dt>
                  <dd>{{ summary.accident.damage_type|default:"–" }}</dd>
                </div>
                <div>
                  <dt>Unfallgegner</dt>
                  <dd>{% if summary.accident.other_party_involved %}Ja{% else %}Nein{% endif %}</dd>
                </div>
                <div>
                  <dt>Polizei involviert</dt>
                  <dd>{% if summary.accident.police_involved %}Ja{% else %}Nein{% endif %}</dd>
                </div>
                <div>
                  <dt>Fotos</dt>
                  <dd>
                    {% if photos %}
                      <div class="rl-summary-photos">
                        {% for file in photos %}
                          <div class="rl-summary-photo">
                            {% if file.url %}
                              <img src="{{ file.url }}" alt="{{ file.name }}" loading="lazy">
                            {% endif %}
                            <div class="rl-summary-photo__meta">
                              <span class="rl-summary-photo__name">{{ file.name }}</span>
                              <span class="rl-summary-photo__size">{{ file.size|filesizeformat }}</span>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      Kein Foto hochgeladen.
                    {% endif %}
                  </dd>
                </div>
                <div>
                  <dt>Dokumente</dt>
                  <dd>
                    {% if summary.accident.documents %}
                      <ul class="rl-summary-list">
                        {% for doc in summary.accident.documents %}
                          <li>{{ doc.name|default:doc }}</li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      Keine Dokumente hochgeladen.
                    {% endif %}
                  </dd>
                </div>
              </dl>
            </section>
          </div>

          <div class="rl-confirm-box">
            <label class="rl-confirm-box__content" for="{{ form.confirm.id_for_label }}">
              {{ form.confirm }}
              <span class="rl-confirm-box__text">Ich bestätige, dass die Angaben korrekt sind.</span>
            </label>
            {{ form.confirm.errors }}
          </div>
        {% endif %}

      <!-- Navigation / Buttons -->
      <div class="rl-wizard-actions">
        {% if wizard.steps.prev %}
          <button type="submit"
                  name="wizard_goto_step"
                  value="{{ wizard.steps.prev }}"
                  class="rl-wizard-btn rl-wizard-btn--ghost"
                  formnovalidate>
            ← Zurück
          </button>
        {% else %}
          <button type="button"
                  class="rl-wizard-btn rl-wizard-btn--ghost"
                  disabled>
            ← Zurück
          </button>
        {% endif %}

        <div class="rl-wizard-actions-right">
          {% if wizard.steps.current == "review" %}
            <button type="submit" class="rl-wizard-btn rl-wizard-btn--primary">
              Schadenmeldung absenden
              <span class="rl-wizard-btn-icon">➜</span>
            </button>
          {% else %}
            <button type="submit" class="rl-wizard-btn rl-wizard-btn--primary">
              Weiter
              <span class="rl-wizard-btn-icon">➜</span>
            </button>
          {% endif %}
        </div>
      </div>
    </form>
  </section>
</section>
<script>
document.addEventListener('DOMContentLoaded',function(){
  const input = document.getElementById('{{ form.photos.id_for_label }}');
  const drop  = document.querySelector('.rl-upload-dropzone');
  const list  = document.querySelector('.rl-upload-filelist');
  if(!input || !drop) return;

  drop.addEventListener('click', function(){
    input.click();
  });

  input.addEventListener('change', function(){
    if(!list) return;
    list.innerHTML = '';
    if(!this.files || !this.files.length){
      list.textContent = 'Keine Dateien ausgewählt.';
      return;
    }
    const files = Array.from(this.files).slice(0,5);
    if(this.files.length > files.length){
      const note = document.createElement('div');
      note.className = 'rl-upload-file rl-upload-file--warning';
      note.textContent = 'Es werden nur die ersten 5 Dateien übernommen.';
      list.appendChild(note);
    }
    files.forEach(function(f){
      const row = document.createElement('div');
      row.className = 'rl-upload-file';
      row.textContent = f.name;
      list.appendChild(row);
    });
  });
});
</script>
{% endblock %}
